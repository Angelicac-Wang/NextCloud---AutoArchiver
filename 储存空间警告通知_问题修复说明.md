# 储存空间警告通知 - 问题修复说明

## 📋 问题分析

### 1. 测试 3 和测试 6 的关系

**是的，它们使用同一个 Job：`StorageMonitorJob`**

- **测试 3（储存空间监控）**：测试系统在存储使用率超过 80% 时自动封存文件
- **测试 6（储存空间警告通知）**：测试系统发送警告通知并允许用户选择是否封存

这个 Job 在检测到存储使用率超过阈值时会执行两个操作：
1. 发送储存空间警告通知（24小时内只发送一次）
2. 自动封存最久未使用的档案以释放空间

### 2. 发现的严重问题 ⚠️

**问题：用户点击"不要封存"按钮后，系统仍然会自动封存文件！**

#### 问题原因

在修复前，`StorageMonitorJob` 的执行流程是：

```php
if ($usageInfo['overThreshold']) {
    // 1. 发送警告通知
    $this->sendStorageWarningNotification($user, $usageInfo);
    
    // 2. 立即开始自动封存（没有检查用户决策！）
    $archivedCount = $this->archiveUntilBelowThreshold($user, $usageInfo);
}
```

这意味着：
- ❌ 即使用户点击"不要封存"，系统仍会自动封存文件
- ❌ 用户的决策被忽略
- ❌ "不要封存"按钮形同虚设

## ✅ 修复方案

### 修改的文件

1. **`my-apps/auto_archiver/lib/Cron/StorageMonitorJob.php`**
   - 在自动封存前检查用户决策
   - 添加 `getUserStorageDecision()` 方法

### 修复后的执行流程

```php
if ($usageInfo['overThreshold']) {
    // 1. 发送警告通知
    $this->sendStorageWarningNotification($user, $usageInfo);
    
    // 2. 检查用户是否选择不要封存
    $userDecision = $this->getUserStorageDecision($user->getUID());
    
    if ($userDecision === 'skip_archive') {
        // 用户选择不封存，跳过自动封存
        $this->logger->warning("User chose 'skip_archive', will not automatically archive files");
    } else {
        // 用户未做决策或选择允许封存，执行自动封存
        $archivedCount = $this->archiveUntilBelowThreshold($user, $usageInfo);
    }
}
```

### 新增的方法

```php
/**
 * 获取用户的储存空间决策
 * 返回 'skip_archive' 表示用户选择不要封存
 * 返回 null 表示用户未做决策或决策已过期（24小时）
 */
private function getUserStorageDecision(string $userId): ?string
```

此方法会：
- 查询 `oc_archiver_decisions` 表中的用户决策
- 只返回 24 小时内的决策（过期自动失效）
- 如果用户选择了 `skip_archive`，返回该决策
- 否则返回 `null`

## 🔄 修复后的行为

### 场景 1：用户点击"不要封存"

1. 用户点击"不要封存"按钮
2. 决策记录到数据库（`decision = 'skip_archive'`, `decided_at = 当前时间`）
3. 下次 StorageMonitorJob 运行时：
   - ✅ 检测到存储使用率超过 80%
   - ✅ 发送警告通知（如果距离上次通知超过 24 小时）
   - ✅ 检查用户决策，发现是 `skip_archive`
   - ✅ **跳过自动封存，文件保持原样**
   - 📝 日志记录：「User chose 'skip_archive', will not automatically archive files」

4. **24 小时后**：
   - 决策过期
   - 如果使用率仍超过阈值，系统会重新发送通知
   - 用户可以再次选择

### 场景 2：用户点击"忽略"

1. 用户点击"忽略"按钮
2. 通知被删除，**不创建决策记录**
3. 下次 StorageMonitorJob 运行时：
   - ✅ 检测到存储使用率超过 80%
   - ✅ 发送警告通知（如果距离上次通知超过 24 小时）
   - ✅ 检查用户决策，发现没有记录（`null`）
   - ✅ **继续自动封存文件以释放空间**
   - 📝 日志记录：「Archived N files to reduce storage usage」

### 场景 3：用户不做任何操作

1. 通知发送后，用户未点击任何按钮
2. StorageMonitorJob 继续运行时：
   - ✅ 检测到存储使用率超过 80%
   - ❌ 不会重复发送通知（24 小时内）
   - ✅ 检查用户决策，发现没有记录（`null`）
   - ✅ **继续自动封存文件以释放空间**

## 📊 按钮功能对比

| 按钮 | 创建决策记录 | 24小时内效果 | 24小时后效果 |
|------|--------------|--------------|--------------|
| **不要封存** | ✅ 是（`skip_archive`） | 系统不会自动封存文件 | 决策过期，重新发送通知 |
| **忽略** | ❌ 否 | 系统继续自动封存文件 | 如果使用率仍超过阈值，重新发送通知 |

## 🧪 测试建议

### 测试"不要封存"功能

1. 创建超过配额 80% 的文件
2. 执行 StorageMonitorJob
3. 在 Web UI 中查看通知
4. 点击"不要封存"按钮
5. 再次执行 StorageMonitorJob
6. **验证**：文件未被封存，日志中有「User chose 'skip_archive'」记录
7. 24 小时后再次测试，验证决策已过期

### 测试"忽略"功能

1. 创建超过配额 80% 的文件
2. 执行 StorageMonitorJob
3. 在 Web UI 中查看通知
4. 点击"忽略"按钮
5. 再次执行 StorageMonitorJob
6. **验证**：文件被自动封存，使用率降低

## 📝 相关文档更新

- ✅ `DEVELOPER_GUIDE joe.md` - 测试 6 的步骤已更新
  - 添加步骤 5.5：验证 StorageMonitorJob 尊重用户决策
  - 更新预期结果总结，说明 24 小时有效期
  - 添加重要说明，解释两个按钮的区别

## 🔧 需要做的事情

如果你想测试修复后的功能：

1. **重新启用应用**（使修改生效）：
   ```bash
   docker compose exec app php occ app:disable auto_archiver
   docker compose exec app php occ app:enable auto_archiver
   ```

2. **按照测试 6 的步骤进行测试**

3. **验证日志输出**：
   ```bash
   docker compose exec app bash -c "tail -n 100 data/nextcloud.log | grep -i 'storagemonitor\|skip_archive'"
   ```

## ⚠️ 注意事项

1. **24 小时有效期**：用户的"不要封存"决策只在 24 小时内有效
2. **自动重新通知**：24 小时后如果使用率仍超过阈值，系统会重新发送通知
3. **"忽略"不会阻止封存**：点击"忽略"只是关闭通知，系统仍会自动封存
4. **决策记录清理**：建议定期清理过期的决策记录（可以添加清理任务）

---

**修复完成日期**：2025-11-30  
**修复版本**：v1.2.0  
**修复者**：AI Assistant

